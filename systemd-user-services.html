<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>systemd user services</title>
<meta name="generator" content="Org Mode" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
<meta property="og:title" content="systemd user services">
<meta property="og:description" content="">
<meta property="og:image" content="https://notes.neeasade.net/assets/posts/ca_dump3/a611aeda3493f32a6f1c739fed98e2ca622bb829b71fe4d656815137713b6ceb.png">
<meta property="og:url" content="https://notes.neeasade.net/systemd-user-services">
<meta property="description" content="">
<meta name="twitter:card" content="summary">
<script src="./assets/js/linktext.js" defer></script>
<style> body {background: url("./assets/posts/ca_dump3/a611aeda3493f32a6f1c739fed98e2ca622bb829b71fe4d656815137713b6ceb.png") repeat;} </style>
<style> body {background-size: auto 486px !important; } </style>
<script src=".//assets/js/copy.js" defer></script>
<script data-goatcounter="https://neeasade.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
<script src="//instant.page/5.1.0" type="module" integrity="sha384-by67kQnR+pyfy8yWP4kPO12fHKRLHZPfEsiSXR8u2IKcTdxD805MGUXBzVPnkLHw"></script>
<link rel='stylesheet' href='./assets/css/colors.css?sum=cbc7f86dcba5597749ac3221baabf396'>
<link rel='stylesheet' href='./assets/css/normalize.css?sum=112272e51c80ffe5bd01becd2ce7d656'>
<link rel='stylesheet' href='./assets/css/magick.css?sum=de2a5435182495e691565c7d598903bd'>
<link rel='stylesheet' href='./assets/css/notes.css?sum=5a7a29b051265cf89a5173ca895cc6d0'>
</head>
<body>
<main id="content" class="content">
<header>
<div style="float: left">
    <a href='./index.html'>../notes</a>
</div>

<div style="float: right">
    
    <a href="https://raw.githubusercontent.com/neeasade/neeasade.github.io/source/posts/2020-12-31-systemd-user-services.org">source</a>
</div>
<h1 class=title>
    <svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
        <rect x="5" y="15" width="20" height="20" fill="none" stroke="#444748" stroke-width="2"/>
        <rect x="14" y="6" width="20" height="20" fill="none" stroke="#444748" stroke-width="2"/>
    </svg>
    systemd user services
    <svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
        <rect x="5" y="15" width="20" height="20" fill="none" stroke="#444748" stroke-width="2"/>
        <rect x="14" y="6" width="20" height="20" fill="none" stroke="#444748" stroke-width="2"/>
    </svg>
</h1>
<div class="org-center">
<p>

</p>
</div>
<span class=pubinfo>
    Published 2021-01-02,
    last edit <a href="https://github.com/neeasade/neeasade.github.io/commits/source/posts/2020-12-31-systemd-user-services.org">2021-01-04</a>
</span>
<div class="posttags"> <a href='./tag-linux.html'>#linux</a><a href='./tag-script.html'>#script</a> </div>
</header>
<hr>
<p>
This is a text version of a lighting talk I gave at <a href="https://www.recurse.com">recurse center</a> Feb 2020.
</p>

<p>
Back when I was first getting into Linux, I had arch installed on my laptop that I was using for schoolwork, and  was trying all the latest ｍｎｍｌ window managers, which meant there was no builtin display for how much battery I had left.
</p>

<p>
Some googling showed me that you could do the following to get the charge on Linux:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cat /sys/class/power_supply/BAT0/capacity
92
</pre>
</div>

<p>
That&rsquo;s a pain to type out, so I aliased it to something spam-able like <code>a</code> and called it a day. But then&#x2026; surprise shutdowns still happened on occasion. So I just got into the habit of spamming checking all the time due to laptop FOMO. This is not ideal.
</p>

<p>
Next step was to wrap the above in a script and display it in my panel. Nice! now the battery status is always a glance away. BUT! pixel real estate is precious on my 1366 x 768 resolution, so I would often hide the panel or full-screen something like media, or my text editor. We are back where we started.
</p>
<div id="outline-container-h-9c426974-626d-47cf-bca6-c2b71698b392" class="outline-2">
<h2 id="h-9c426974-626d-47cf-bca6-c2b71698b392">Alerts<a href="#h-9c426974-626d-47cf-bca6-c2b71698b392">#</a></h2>
<div class="outline-text-2" id="text-h-9c426974-626d-47cf-bca6-c2b71698b392">
<p>
With something like <a href="https://github.com/dunst-project/dunst">dunst</a>, I can send notifications that appear only when I&rsquo;m concerned with them. This birthed a script that would only bother me if my battery was below a certain level, while polling periodically. I decoupled that last part into a script named <a href="https://github.com/neeasade/dotfiles/blob/master/wm/.wm/scripts/services/periodically"><code>periodically</code></a>, so ended up with a <code>battery_alert</code> daemon-like script that looked like <code>periodically 60 check_battery</code>.
</p>

<p>
Making this call in my <code>.xinitrc</code> worked out OK, but I&rsquo;m sometimes at a desktop using the same set of dotfiles, and there&rsquo;s no battery to check there. About this point I realized I had stuffed a lot in my startup, such as <code>mpd</code>, <code>picom</code>, <code>dunst</code>, you name it. I had heard of systemd user services and decided to look into them.
</p>
</div>
</div>
<div id="outline-container-h-bedee5e8-3ef1-4038-9bc8-33640146db06" class="outline-2">
<h2 id="h-bedee5e8-3ef1-4038-9bc8-33640146db06">The big D<a href="#h-bedee5e8-3ef1-4038-9bc8-33640146db06">#</a></h2>
<div class="outline-text-2" id="text-h-bedee5e8-3ef1-4038-9bc8-33640146db06">
<p>
Systemd user services are regular systemd service files that live in <code>$HOME/.config/systemd/user</code>. A service file matching the above problem might look like this:
</p>

<p>
<code>battery_alert.service</code>:
</p>
<div class="org-src-container">
<pre class="src src-conf">[<span style="color: #006e96;">Unit</span>]
<span style="color: #c6007f;">Description</span>=Notify when the battery is low

[<span style="color: #006e96;">Service</span>]
<span style="color: #c6007f;">ExecStart</span>=/path/to/bin/periodically 60 check_battery
<span style="color: #c6007f;">ExecStop</span>=/path/to/bin/kill -int $MAINPID

<span style="color: #c6007f;">Environment</span>=PATH=/paths/that/contain/check_battery:...:....
<span style="color: #c6007f;">Environment</span>=DISPLAY=<span style="color: #007c00;">":0"</span>
<span style="color: #c6007f;">Environment</span>=XAUTHORITY=<span style="color: #007c00;">"/home/neeasade/.Xauthority"</span>

[<span style="color: #006e96;">Install</span>]
<span style="color: #c6007f;">WantedBy</span>=default.target
</pre>
</div>

<p>
Some things to note:
</p>

<ul class="org-ul">
<li>The full path to the <code>ExecStart</code> and <code>ExecStop</code> executable</li>
<li>The inclusion of <code>DISPLAY</code> and <code>XAUTHORITY</code> &#x2013; this is so the <code>notify-send</code> reaches dunst</li>
<li>The setting of <code>PATH</code> such that &ldquo;the usual suspects&rdquo; are available within my daemon script</li>
</ul>

<p>
With the above I get the systemd goodness but for managing my local stuff, just passing <code>--user</code>:
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #6a6d6e;"># </span><span style="color: #6a6d6e;">start, stop</span>
systemctl --user start battery_alert
systemctl --user stop battery_alert

<span style="color: #6a6d6e;"># </span><span style="color: #6a6d6e;">logs (can also tail theme)</span>
systemctl --user status battery_alert

<span style="color: #6a6d6e;"># </span><span style="color: #6a6d6e;">automatic startup</span>
systemctl --user enable battery_alert
</pre>
</div>

<p>
So the next step in this systemd journey was to integrate <a href="https://github.com/neeasade/dotfiles/blob/cd6a4cd7c8207b7300bf0bf75f87aee8a7e4fbc1/wm/.wm/scripts/theming/ltheme#L379-L465">service generation</a> into my dotfiles setup, generating a number of service files that contain full paths to binaries with intended arguments for a range of daemons.
</p>
</div>
</div>
<div id="outline-container-h-42fac00e-07ec-4d8d-849f-eaf1a86bb935" class="outline-2">
<h2 id="h-42fac00e-07ec-4d8d-849f-eaf1a86bb935">The big.. T?<a href="#h-42fac00e-07ec-4d8d-849f-eaf1a86bb935">#</a></h2>
<div class="outline-text-2" id="text-h-42fac00e-07ec-4d8d-849f-eaf1a86bb935">
<p>
Those of you in the know will see something very wrong with the above. Systemd has a &ldquo;when to run&rdquo; concept: <a href="https://www.freedesktop.org/software/systemd/man/systemd.timer.html">timers</a>! Using timers files you can do things like:
</p>

<ul class="org-ul">
<li>run on boot</li>
<li>run on login</li>
<li>run once per day/once per time interval</li>
<li>run <b>periodically</b></li>
</ul>

<p>
Let&rsquo;s take a look at what that last one looks like. You create a file in the same directory with the same name, but extension timer:
</p>

<p>
<code>battery_alert.timer</code>:
</p>
<div class="org-src-container">
<pre class="src src-conf">[<span style="color: #006e96;">Unit</span>]
<span style="color: #c6007f;">Description</span>=Run check_battery every 60 seconds

[<span style="color: #006e96;">Timer</span>]

<span style="color: #6a6d6e;"># </span><span style="color: #6a6d6e;">on boot</span>
<span style="color: #6a6d6e;"># </span><span style="color: #6a6d6e;">OnBootSec=0min</span>

<span style="color: #6a6d6e;"># </span><span style="color: #6a6d6e;">on service manager activation</span>
<span style="color: #c6007f;">OnStartupSec</span>=0min

<span style="color: #c6007f;">OnUnitActiveSec</span>=60s

[<span style="color: #006e96;">Install</span>]
<span style="color: #c6007f;">WantedBy</span>=timers.target
</pre>
</div>

<p>
See the reference for time-span syntax <a href="https://www.freedesktop.org/software/systemd/man/systemd.time.html#">here</a>
</p>

<p>
And then we would change the <code>ExecStart</code> in our <code>battery_alert.service</code> file to:
</p>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #c6007f;">ExecStart</span>=/path/to/check_battery
</pre>
</div>

<p>
And bam! we have done the thing.
</p>

<footer>
    <div style="float: left">
         <a href='passionate-state-of-mind.html'>newer: passionate state of mind</a> 
    </div>
    <div style="text-align: right">
         <a href='calf-path.html'>older: The Calf Path</a> 
    </div>
</footer>
<hr>
</div>
</div>
</main>
</body>
</html>
